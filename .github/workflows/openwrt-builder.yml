# 工作流名称，可自定义
name: Only Compile luci-app-netspeedtest Plugin
# 手动触发运行（无需自动触发，避免误操作）
on:
  workflow_dispatch:

jobs:
  # 单个编译任务
  build-single-plugin:
    # 使用GitHub中等性能服务器（足够编译单个插件）
    runs-on: ubuntu-22.04
    # 任务步骤
    steps:
      # 步骤1：拉取当前仓库的配置文件（必备基础步骤）
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：安装最小化编译依赖（仅满足插件编译需求，不冗余）
      - name: Install Minimal Build Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget

      # 步骤3：克隆OpenWrt 23.05源码（仅拉取浅层源码，节省时间和空间）
      - name: Clone OpenWrt 23.05 Source Code (Shallow)
        run: |
          # 克隆OpenWrt 23.05分支，深度1（仅最新版本，无历史提交）
          git clone -b openwrt-23.05 --depth=1 https://git.openwrt.org/openwrt/openwrt.git openwrt
          cd openwrt
          # 更新并安装OpenWrt基础feeds（仅满足插件依赖，不额外下载）
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 步骤4：克隆测速插件源码（仅添加这一个插件，无其他多余插件）
      - name: Add Only luci-app-netspeedtest Source Code
        run: |
          cd openwrt
          # 克隆官方插件源码到package目录，仅这一个插件
          git clone https://github.com/sirpdboy/luci-app-netspeedtest package/luci-app-netspeedtest

      # 步骤5：配置编译环境（仅指定MT7621架构+勾选单个插件，不配置固件相关）
      - name: Configure MT7621 & Only Single Plugin
        run: |
          cd openwrt
          # 核心配置：仅指定架构为MT7621 + 勾选测速插件，无其他多余配置
          echo -e "CONFIG_TARGET_ramips=y\nCONFIG_TARGET_ramips_mt7621=y\nCONFIG_PACKAGE_luci-app-netspeedtest=y" > .config
          # 生成默认配置（验证配置有效性，无多余操作）
          make defconfig

      # 步骤6：单独编译测速插件（核心步骤，仅编译这一个插件，不编译其他任何组件）
      - name: Compile Only luci-app-netspeedtest Plugin
        run: |
          cd openwrt
          # 仅编译luci-app-netspeedtest插件，V=s显示简易日志（方便排错，不冗余）
          make package/luci-app-netspeedtest/compile V=s

      # 步骤7：上传仅插件包作为产物（仅上传测速插件，无固件文件）
      - name: Upload Only luci-app-netspeedtest Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          # 产物名称，可自定义
          name: luci-app-netspeedtest-mt7621-only
          # 仅指定测速插件包的路径，无其他文件
          path: openwrt/bin/packages/mipsel_24kc/luci/luci-app-netspeedtest_*.ipk
