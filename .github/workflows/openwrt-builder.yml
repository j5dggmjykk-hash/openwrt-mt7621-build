name: Build OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
        file wget

    - name: Clone OpenWrt 23.05
      run: |
        git clone -b openwrt-23.05 --depth=1 https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Add luci-app-netspeedtest source code
      run: |
        cd openwrt
        # 拉取 netspeedtest 插件源码到 package 目录（编译环境可识别）
        git clone https://github.com/sirpdboy/luci-app-netspeedtest.git package/luci-app-netspeedtest

    - name: Configure build (MT7621 architecture)
      run: |
        cd openwrt
        # 配置目标架构为 ramips/mt7621（适配你的小米路由器3G等设备）
        echo -e "CONFIG_TARGET_ramips=y\nCONFIG_TARGET_ramips_mt7621=y\nCONFIG_TARGET_MULTI_PROFILE=y\nCONFIG_TARGET_DEVICE_ramips_mt7621_DEVICE_xiaomi_mi-router-3g=y\nCONFIG_LUCI_APP_NETSPEEDTEST=y" > .config
        make defconfig

    - name: Compile OpenWrt & Package
      run: |
        cd openwrt
        # 开始编译（-j$(nproc) 自动调用所有CPU核心加速编译）
        make download -j$(nproc)
        make -j$(nproc) || make -j1 V=s

    - name: Upload artifact
      uses: actions/upload-artifact@v4  # 已更新为最新支持的 v4 版本
      with:
        name: luci-app-netspeedtest-mt7621
        path: |
          openwrt/bin/packages/*/luci/luci-app-netspeedtest_*.ipk
          openwrt/bin/targets/ramips/mt7621/*/*.ipk
