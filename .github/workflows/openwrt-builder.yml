name: Build OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare build env
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3

      - name: Clone OpenWrt 23.05
        run: |
          git clone -b openwrt-23.05 https://git.openwrt.org/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure MT7621 + netspeedtest
        run: |
          cd openwrt
          # 配置MT7621架构
          echo -e "CONFIG_TARGET_ramips=y\nCONFIG_TARGET_ramips_mt7621=y" >> .config
          # 启用luci-app-netspeedtest
          echo -e "CONFIG_PACKAGE_luci-app-netspeedtest=y\nCONFIG_PACKAGE_luci-i18n-netspeedtest-zh-cn=y" >> .config
          make defconfig

      - name: Compile package
        run: |
          cd openwrt
          make download -j8
          make package/luci-app-netspeedtest/compile V=s -j$(nproc)

      - name: Upload ipk
        uses: actions/upload-artifact@v3
        with:
          name: luci-app-netspeedtest-mt7621
          path: openwrt/bin/packages/mipsel_24kc/luci/*.ipk
