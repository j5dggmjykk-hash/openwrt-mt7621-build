name: Build NetSpeedTest Plugin
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare env
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
      - name: Clone OpenWrt 23.05
        run: |
          git clone -b openwrt-23.05 --depth=1 https://git.openwrt.org/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: Add NetSpeedTest source（用这个仓库的源码）
        run: |
          cd openwrt
          git clone https://github.com/sirpdboy/luci-app-netspeedtest package/netspeedtest
      - name: Configure MT7621 & Plugin
        run: |
          cd openwrt
          # 配置架构为MT7621 + 勾选插件
          echo -e "CONFIG_TARGET_ramips=y\nCONFIG_TARGET_ramips_mt7621=y\nCONFIG_PACKAGE_luci-app-netspeedtest=y" > .config
          make defconfig
      - name: Compile Plugin
        run: |
          cd openwrt
          make package/netspeedtest/luci-app-netspeedtest/compile V=s
      - name: Upload Plugin
        uses: actions/upload-artifact@v4
        with:
          name: netspeedtest-mt7621
          path: openwrt/bin/packages/mipsel_24kc/luci/luci-app-netspeedtest_*.ipk
